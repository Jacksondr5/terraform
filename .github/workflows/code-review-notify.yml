name: Code Review Notification

on:
  workflow_call:
    inputs:
      sleep_seconds:
        description: "Seconds to wait for event debouncing"
        required: false
        type: number
        default: 90
      notified_reaction:
        description: "Reaction to mark reviews as notified (GraphQL enum)"
        required: false
        type: string
        default: "EYES"
      handled_reaction:
        description: "Reaction that indicates a review has been handled (GraphQL enum)"
        required: false
        type: string
        default: "ROCKET"
      log_event_payload:
        description: "Whether to log the full event payload (contains sensitive data)"
        required: false
        type: boolean
        default: false
    secrets:
      DISCORD_WEBHOOK_URL:
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Log full event payload
        if: ${{ inputs.log_event_payload }}
        env:
          EVENT_NAME: ${{ github.event_name }}
          EVENT_ACTION: ${{ github.event.action }}
          EVENT_JSON: ${{ toJSON(github.event) }}
        run: |
          echo "::group::Event: ${EVENT_NAME} (${EVENT_ACTION})"
          echo "$EVENT_JSON" | jq .
          echo "::endgroup::"

      - name: Wait for events to settle
        run: sleep ${{ inputs.sleep_seconds }}

      - name: Check for unnotified reviews and notify
        uses: actions/github-script@v7
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          NOTIFIED_REACTION: ${{ inputs.notified_reaction }}
          HANDLED_REACTION: ${{ inputs.handled_reaction }}
        with:
          script: |
            const notifiedReaction = process.env.NOTIFIED_REACTION;
            const handledReaction = process.env.HANDLED_REACTION;
            const event = context.payload;

            // Resolve PR number from different event types
            const prNumber = event.pull_request?.number
              || event.issue?.number
              || event.review?.pull_request?.number;

            if (!prNumber) {
              console.log('Could not resolve PR number from event, skipping');
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Fetch reviews with reactions via GraphQL
            const query = `
              query($owner: String!, $repo: String!, $pr: Int!) {
                repository(owner: $owner, name: $repo) {
                  pullRequest(number: $pr) {
                    title
                    url
                    reviews(first: 100) {
                      nodes {
                        id
                        databaseId
                        body
                        state
                        author { login }
                        reactionGroups {
                          content
                          reactors { totalCount }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const result = await github.graphql(query, {
              owner,
              repo,
              pr: prNumber,
            });

            const pr = result.repository.pullRequest;
            const reviews = pr.reviews.nodes;

            // Find reviews that don't have the notified reaction AND don't have the handled reaction
            const unnotifiedReviews = reviews.filter(review => {
              // Skip reviews with no body (empty replies, acks)
              if (!review.body || review.body.trim() === '') return false;

              const hasNotified = review.reactionGroups.some(
                g => g.content === notifiedReaction && g.reactors.totalCount > 0
              );
              const hasHandled = review.reactionGroups.some(
                g => g.content === handledReaction && g.reactors.totalCount > 0
              );

              // Skip if already notified or already handled
              return !hasNotified && !hasHandled;
            });

            if (unnotifiedReviews.length === 0) {
              console.log(`No unnotified reviews found for ${repo}#${prNumber}, skipping`);
              return;
            }

            console.log(`Found ${unnotifiedReviews.length} unnotified review(s) on ${repo}#${prNumber}`);
            for (const r of unnotifiedReviews) {
              console.log(`  - Review ${r.databaseId} by ${r.author?.login || 'unknown'} (${r.state})`);
            }

            // Send a simple notification to Discord
            const payload = {
              embeds: [{
                title: `üîç New Code Review Activity`,
                description: `**[${repo}#${prNumber}](${pr.url})** ‚Äî ${pr.title}\n\n${unnotifiedReviews.length} review(s) to process.`,
                color: 0x5865F2,
                timestamp: new Date().toISOString(),
                footer: {
                  text: `${repo} ‚Ä¢ PR #${prNumber}`,
                },
              }],
            };

            const response = await fetch(process.env.DISCORD_WEBHOOK_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            });

            if (!response.ok) {
              throw new Error(`Discord webhook failed: ${response.status} ${await response.text()}`);
            }

            // Mark all unnotified reviews with the notified reaction
            const addReactionMutation = `
              mutation($subjectId: ID!, $content: ReactionContent!) {
                addReaction(input: { subjectId: $subjectId, content: $content }) {
                  reaction { content }
                }
              }
            `;

            for (const review of unnotifiedReviews) {
              await github.graphql(addReactionMutation, {
                subjectId: review.id,
                content: notifiedReaction,
              });
              console.log(`Marked review ${review.databaseId} with ${notifiedReaction}`);
            }

            console.log(`Notification sent and ${unnotifiedReviews.length} review(s) marked for ${repo}#${prNumber}`);
