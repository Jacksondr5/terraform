name: Code Review Notification

on:
  workflow_call:
    inputs:
      sleep_seconds:
        description: "Seconds to wait for event debouncing"
        required: false
        type: number
        default: 90
      notified_reaction:
        description: "Reaction to mark comments as notified"
        required: false
        type: string
        default: "eyes"
    secrets:
      DISCORD_WEBHOOK_URL:
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Log full event payload
        env:
          EVENT_NAME: ${{ github.event_name }}
          EVENT_ACTION: ${{ github.event.action }}
          EVENT_JSON: ${{ toJSON(github.event) }}
        run: |
          echo "::group::Event: ${EVENT_NAME} (${EVENT_ACTION})"
          echo "$EVENT_JSON" | jq .
          echo "::endgroup::"

      - name: Wait for events to settle
        run: sleep ${{ inputs.sleep_seconds }}

      - name: Check for unnotified reviews and notify
        uses: actions/github-script@v7
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          NOTIFIED_REACTION: ${{ inputs.notified_reaction }}
        with:
          script: |
            const event = context.payload;
            const notifiedReaction = process.env.NOTIFIED_REACTION;

            // Resolve PR number from different event types
            const prNumber = event.pull_request?.number
              || event.issue?.number
              || event.review?.pull_request?.number;

            if (!prNumber) {
              console.log('Could not resolve PR number from event, skipping');
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Fetch the PR details
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber,
            });

            // Fetch all review comments (inline code comments)
            const { data: reviewComments } = await github.rest.pulls.listReviewComments({
              owner,
              repo,
              pull_number: prNumber,
              per_page: 100,
            });

            // Find comments that haven't been marked with the notified reaction
            const unnotifiedComments = [];
            for (const comment of reviewComments) {
              const { data: reactions } = await github.rest.reactions.listForPullRequestReviewComment({
                owner,
                repo,
                comment_id: comment.id,
              });

              const hasNotifiedReaction = reactions.some(r => r.content === notifiedReaction);
              if (!hasNotifiedReaction) {
                unnotifiedComments.push(comment);
              }
            }

            if (unnotifiedComments.length === 0) {
              console.log(`No unnotified review comments found for ${repo}#${prNumber}, skipping`);
              return;
            }

            console.log(`Found ${unnotifiedComments.length} unnotified comment(s) on ${repo}#${prNumber}`);

            // Send a simple notification to Discord ‚Äî the code-reviewer agent
            // will independently fetch all review details
            const payload = {
              embeds: [{
                title: `üîç New Code Review Activity`,
                description: `**[${repo}#${prNumber}](${pr.html_url})** ‚Äî ${pr.title}\n\n${unnotifiedComments.length} new review comment(s) to process.`,
                color: 0x5865F2,
                timestamp: new Date().toISOString(),
                footer: {
                  text: `${repo} ‚Ä¢ PR #${prNumber}`,
                },
              }],
            };

            const response = await fetch(process.env.DISCORD_WEBHOOK_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            });

            if (!response.ok) {
              throw new Error(`Discord webhook failed: ${response.status} ${await response.text()}`);
            }

            // Mark all unnotified comments with the notified reaction
            for (const comment of unnotifiedComments) {
              await github.rest.reactions.createForPullRequestReviewComment({
                owner,
                repo,
                comment_id: comment.id,
                content: notifiedReaction,
              });
              console.log(`Marked comment ${comment.id} with ${notifiedReaction}`);
            }

            console.log(`Notification sent and ${unnotifiedComments.length} comment(s) marked for ${repo}#${prNumber}`);
